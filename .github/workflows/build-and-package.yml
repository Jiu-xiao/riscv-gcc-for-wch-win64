name: build-and-package

on:
  workflow_dispatch:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  build_toolchain:
    runs-on: ubuntu-latest
    timeout-minutes: 720
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          set -euxo pipefail
          docker build -f Dockerfile.builder -t riscv-gcc-builder-full .

      - name: Build toolchain in container
        run: |
          set -euxo pipefail
          mkdir -p out
          docker run --rm \
            -e JOBS_STAGE1=32 \
            -e JOBS_FINAL=32 \
            -e MAKE_RETRIES=6 \
            -e MAKE_RETRY_DELAY=8 \
            -v "${{ github.workspace }}:/work" \
            -v "${{ github.workspace }}/out:/out" \
            riscv-gcc-builder-full \
            /bin/bash -lc "bash /work/build.sh"

      - name: Verify toolchain files
        run: |
          set -euxo pipefail
          test -f out/riscv/bin/riscv32-unknown-elf-gcc.exe
          test -f out/riscv/bin/riscv32-unknown-elf-g++.exe
          test -f out/riscv/bin/riscv32-unknown-elf-gdb.exe
          test -f out/riscv/bin/riscv32-unknown-elf-readelf.exe
          test -f out/riscv/bin/libstdc++-6.dll
          test -f out/riscv/bin/libgcc_s_seh-1.dll

      - name: Upload toolchain artifact
        uses: actions/upload-artifact@v4
        with:
          name: riscv-toolchain-dir
          path: out/riscv
          if-no-files-found: error
          compression-level: 0

  build_installer:
    needs: build_toolchain
    runs-on: windows-latest
    timeout-minutes: 240
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download toolchain artifact
        uses: actions/download-artifact@v4
        with:
          name: riscv-toolchain-dir
          path: out/riscv

      - name: Verify downloaded toolchain files
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $required = @(
            "out\\riscv\\bin\\riscv32-unknown-elf-gcc.exe",
            "out\\riscv\\bin\\riscv32-unknown-elf-g++.exe",
            "out\\riscv\\bin\\riscv32-unknown-elf-gdb.exe",
            "out\\riscv\\bin\\riscv32-unknown-elf-readelf.exe",
            "out\\riscv\\bin\\libstdc++-6.dll",
            "out\\riscv\\bin\\libgcc_s_seh-1.dll"
          )
          foreach ($path in $required) {
            if (!(Test-Path $path)) {
              throw "Missing downloaded toolchain file: $path"
            }
          }

      - name: Build installer exe
        shell: powershell
        run: |
          .\build-installer.ps1

      - name: Smoke test installer
        shell: powershell
        run: |
          .\test-installer.ps1 -SourceDir (Join-Path $pwd 'out\riscv')

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: riscv-toolchain-installer
          path: out/installer/riscv-toolchain-installer.exe
          if-no-files-found: error

      - name: Install 7-Zip
        shell: powershell
        run: |
          choco install 7zip -y --no-progress

      - name: Build single-file full installer (SFX EXE)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $releaseDir = Join-Path $pwd "out\release"
          $bundleDir = Join-Path $pwd "out\bundle"
          New-Item -ItemType Directory -Force -Path $releaseDir | Out-Null
          New-Item -ItemType Directory -Force -Path $bundleDir | Out-Null

          $installCmd = Join-Path $bundleDir "install.cmd"
          @'
          @echo off
          setlocal
          for %%I in ("%~dp0..") do set "ROOT=%%~fI\"
          "%ROOT%installer\riscv-toolchain-installer.exe" --source "%ROOT%riscv" %*
          exit /b %ERRORLEVEL%
          '@ | Set-Content -Path $installCmd -Encoding Ascii

          $cfg = Join-Path $bundleDir "sfx-config.txt"
          @'
          ;!@Install@!UTF-8!
          Title="RISC-V Toolchain Installer"
          GUIMode="2"
          RunProgram="bundle\\install.cmd"
          ;!@InstallEnd@!
          '@ | Set-Content -Path $cfg -Encoding Ascii

          $archive = Join-Path $bundleDir "payload.7z"
          if (Test-Path $archive) { Remove-Item -Force $archive }

          Push-Location out
          & "$env:ProgramFiles\7-Zip\7z.exe" a -t7z -mx=9 "$archive" "riscv\*" "installer\riscv-toolchain-installer.exe" "bundle\install.cmd"
          if ($LASTEXITCODE -ne 0) {
            throw "7z archive failed with rc=$LASTEXITCODE"
          }
          Pop-Location

          $sfx = Join-Path $env:ProgramFiles "7-Zip\7z.sfx"
          if (!(Test-Path $sfx)) {
            throw "Missing SFX module: $sfx"
          }

          $fullExe = Join-Path $releaseDir "riscv-toolchain-full-installer.exe"
          if (Test-Path $fullExe) { Remove-Item -Force $fullExe }

          $parts = @($sfx, $cfg, $archive)
          $outStream = [System.IO.File]::Open($fullExe, [System.IO.FileMode]::CreateNew, [System.IO.FileAccess]::Write, [System.IO.FileShare]::None)
          try {
            foreach ($part in $parts) {
              $inStream = [System.IO.File]::Open($part, [System.IO.FileMode]::Open, [System.IO.FileAccess]::Read, [System.IO.FileShare]::Read)
              try {
                $inStream.CopyTo($outStream)
              } finally {
                $inStream.Dispose()
              }
            }
          } finally {
            $outStream.Dispose()
          }

          if (!(Test-Path $fullExe)) {
            throw "SFX combine did not create output: $fullExe"
          }

          Get-Item $fullExe | Select-Object FullName, Length | Format-Table -AutoSize

      - name: Smoke test full installer exe
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $fullExe = Join-Path $pwd "out\release\riscv-toolchain-full-installer.exe"
          if (!(Test-Path $fullExe)) {
            throw "Missing full installer: $fullExe"
          }

          $installDir = Join-Path $pwd "out\full-install-test"
          if (Test-Path $installDir) {
            Remove-Item -Recurse -Force $installDir
          }

          & $fullExe --silent --target $installDir --no-path
          if ($LASTEXITCODE -ne 0) {
            throw "Full installer execution failed with rc=$LASTEXITCODE"
          }

          $required = @(
            (Join-Path $installDir "bin\riscv32-unknown-elf-gcc.exe"),
            (Join-Path $installDir "bin\riscv32-unknown-elf-g++.exe"),
            (Join-Path $installDir "bin\riscv32-unknown-elf-gdb.exe"),
            (Join-Path $installDir "bin\riscv32-unknown-elf-readelf.exe"),
            (Join-Path $installDir "bin\libstdc++-6.dll"),
            (Join-Path $installDir "bin\libgcc_s_seh-1.dll"),
            (Join-Path $installDir "riscv32-unknown-elf\include\stdio.h"),
            (Join-Path $installDir "riscv32-unknown-elf\lib\libstdc++.a")
          )
          foreach ($path in $required) {
            if (!(Test-Path $path)) {
              throw "Missing installed file from full installer: $path"
            }
          }

          & (Join-Path $installDir "bin\riscv32-unknown-elf-gcc.exe") --version | Select-Object -First 1
          if ($LASTEXITCODE -ne 0) {
            throw "full installer gcc --version failed"
          }
          & (Join-Path $installDir "bin\riscv32-unknown-elf-gdb.exe") --version | Select-Object -First 1
          if ($LASTEXITCODE -ne 0) {
            throw "full installer gdb --version failed"
          }

          $helloC = Join-Path $installDir "hello-full.c"
          $helloElf = Join-Path $installDir "hello-full.elf"
          Set-Content -Path $helloC -Value "int main(void){return 0;}" -NoNewline -Encoding Ascii

          & (Join-Path $installDir "bin\riscv32-unknown-elf-gcc.exe") -march=rv32imac -mabi=ilp32 -Os $helloC -o $helloElf
          if ($LASTEXITCODE -ne 0) {
            throw "full installer hello compile failed"
          }

          $elfHeader = & (Join-Path $installDir "bin\riscv32-unknown-elf-readelf.exe") -h $helloElf
          if ($LASTEXITCODE -ne 0) {
            throw "full installer readelf failed"
          }

          $classLine = $elfHeader | Select-String -SimpleMatch "Class:"
          $machineLine = $elfHeader | Select-String -SimpleMatch "Machine:"
          if (-not $classLine) {
            throw "readelf output missing Class line"
          }
          if (-not $machineLine) {
            throw "readelf output missing Machine line"
          }

          Write-Host "    $($classLine.Line)"
          Write-Host "    $($machineLine.Line)"

      - name: Upload full installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: riscv-toolchain-full-installer-exe
          path: out/release/riscv-toolchain-full-installer.exe
          if-no-files-found: error
          compression-level: 0

      - name: Publish GitHub release (one EXE per push)
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: push-${{ github.sha }}
          name: push-${{ github.sha }}
          target_commitish: ${{ github.sha }}
          files: out/release/riscv-toolchain-full-installer.exe
          fail_on_unmatched_files: true
